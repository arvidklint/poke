<!DOCTYPE html>
<html>
  <head>

    <title>poke</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/addons/p5.dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/addons/p5.sound.min.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="ionicons/css/ionicons.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

  <script>
    var socket = io.connect('http://192.168.1.185:3000');
    socket.on('news', function (data) {
      console.log(data);
      socket.emit('my other event', { my: 'banan' });
    });
  </script>

  <script src="sketch.js"></script>

  <script>
    function newPlayer() {
      var name = document.getElementById('name').value;
      var roomName = document.getElementById('roomName').value;
      if(name!="" && roomName!="") {
        // console.log("tried to join");
        socket.emit('join', { name: name, room:roomName});
        document.getElementById('loginHolder').className += "loginHolder";
        document.getElementById('scoreHolder').className += "scoreHolder";

        document.getElementById('scoreTimeLeft').className = "scoreTimeLeftMockup";

        document.getElementById('logout').className = "button";

        var name = document.getElementById('name').blur();
        joined.play();
      }
    }

    var playerList = [];
    var thisPlayer = {};
    var ballPosition = {};
    var cp = {};
    var cpAnimation = false;
    var goalAnimation = false;
    var goalPos;
    var leftGoals = 0;
    var rightGoals = 0;

    socket.on('movePlayer', function(data) {
      for(var player of playerList) {
        if(player.id === data.id) {
          player.x = data.position.x;
          player.y = data.position.y;
        }
      }
    });

    socket.on('allPlayers', function(data) {
      // console.log(data);
      playerList = data;

    });

    socket.on('newPlayer', function(data) {
      // console.log(data);
      playerList.push(data);
    });

    socket.on('remove', function(id) {
      // console.log(id);
      for(var i=0; i<playerList.length;i++) {
        if(playerList[i].id === id) {
          playerList.splice(i, 1);
        }
      }
    });

    socket.on('moveBall', function(data) {
      ballPosition = data;
    });

    var goal = new Audio();
    goal.src = 'goal.wav';
    goal.volume = 1;

    var goalCrash = new Audio();
    goalCrash.src = 'goalCrash.wav';
    goalCrash.volume = 0;

    socket.on('goal', function(data) {
      if(data[0]==='left') {
        rightGoals++;
        document.getElementById('scoreRight').innerHTML = rightGoals;
      } else if(data[0]==='right') {
        leftGoals++;
        document.getElementById('scoreLeft').innerHTML = leftGoals;
      }

      goalAnimation = true;
      goalPos = data[1];

      goal.load();
      goal.play();

      goalCrash.load();
      goalCrash.play();

      socket.emit('scores', { left: leftGoals, right: rightGoals });

    });

    var joined = new Audio();
    joined.src = 'joined2.wav';
    joined.volume = 0.3;

    var ball = new Audio();
    ball.src = 'ball2.wav';
    ball.volume = 0.2;

    var wall = new Audio();
    wall.src = 'wall2.wav';
    wall.volume = 0.2;

    var goal = new Audio();
    goal.src = 'goal3.wav';
    goal.volume = 0.2;

    socket.on('collision', function(data) {
      if(data.type === "ball") {
        ball.playbackRate = random(0.1,5);
        ball.load();
        ball.play();

        cp = data.cp;
        cpAnimation = true;

      } else if(data.type === "wall") {
        wall.playbackRate = random(10);
        wall.load();
        wall.play();

      }
    });

    function logout() {
      document.getElementById('loginHolder').className = "";
      document.getElementById('scoreHolder').className = "";
      document.getElementById('logout').className = "button buttonHide";


      // Add user disconnect to server
    }

    var mute = false;
    function volume() {
      if(mute) {
        document.getElementById('volume').className = "button ion-ios-volume-high";
      } else {
        document.getElementById('volume').className = "button ion-ios-volume-low";
      }
      mute = !mute;

    }



    function runScript(e) {
      if (e.keyCode == 13) {
        newPlayer();
        return false;
      }
    }

  </script>

  </head>

  <body>
    <div id="settings">
      <div id="volume" class="button ion-ios-volume-high" onClick="volume();"></div>
      <div id="logout" class="button buttonHide" onClick="logout();">
        <div class="exitOn ion-ios-close-outline"></div>
        <div class="exitOff ion-ios-close"></div>
      </div>
    </div>
    <div id="scoreHolder">
      <div id="scoreTimeLeft"></div>
      <div id="scoreLeft">0</div>
      <div id="scoreRight">0</div>
    </div>
    <div id="loginHolder">
      <div id="logo"></div>
      <input type="text" id="name" value="" placeholder="nickname" onkeypress="return runScript(event)" autocomplete="off" autofocus></input>
      <input type="submit" id="join" value="JOIN GAME" onClick="newPlayer()"/>
      <div id="room">the roomname is <input type="text" id="roomName" value="#abc"/></div>
    </div>
  </body>

</html>
